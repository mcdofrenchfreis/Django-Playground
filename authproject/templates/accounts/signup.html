{% extends 'base.html' %}
{% block title %}Sign up{% endblock %}
{% block content %}
  <h1>Create your account</h1>
  <form method="post" novalidate class="space-y-4">
    {% csrf_token %}
    {{ form.non_field_errors }}

    <div class="form-control w-full">
      <label class="label"> <span class="label-text">{{ form.username.label }}</span> </label>
      {{ form.username }}
      {% for error in form.username.errors %}<small class="text-error">{{ error }}</small>{% endfor %}
      <small id="username-status" class="text-sm"></small>
    </div>

    <div class="form-control w-full">
      <label class="label"> <span class="label-text">{{ form.email.label }}</span> </label>
      {{ form.email }}
      {% for error in form.email.errors %}<small class="text-error">{{ error }}</small>{% endfor %}
      <small id="email-status" class="text-sm"></small>
    </div>

    <div class="form-control w-full">
      <label class="label"> <span class="label-text">{{ form.password1.label }}</span> </label>
      {{ form.password1 }}
      {% for error in form.password1.errors %}<small class="text-error">{{ error }}</small>{% endfor %}
      <ul id="pw-rules" class="mt-2 text-sm">
        <li id="rule-similar">Your password can’t be too similar to your other personal information.</li>
        <li id="rule-length">Your password must contain at least 8 characters.</li>
        <li id="rule-common">Your password can’t be a commonly used password.</li>
        <li id="rule-numeric">Your password can’t be entirely numeric.</li>
      </ul>
    </div>

    <div class="form-control w-full">
      <label class="label"> <span class="label-text">{{ form.password2.label }}</span> </label>
      {{ form.password2 }}
      {% for error in form.password2.errors %}<small class="text-error">{{ error }}</small>{% endfor %}
    </div>
    <button type="submit" class="btn btn-primary">Sign up</button>
  </form>
  <script>
    const usernameInput = document.getElementById('id_username');
    const emailInput = document.getElementById('id_email');
    const pw1 = document.getElementById('id_password1');

    const ruleSimilar = document.getElementById('rule-similar');
    const ruleLength = document.getElementById('rule-length');
    const ruleCommon = document.getElementById('rule-common');
    const ruleNumeric = document.getElementById('rule-numeric');

    const commonPasswords = new Set([
      'password','123456','123456789','12345678','qwerty','abc123','password1','111111','123123','iloveyou','admin','welcome','dragon','football','monkey','letmein'
    ]);

    function normalize(s){ return (s || '').toLowerCase().trim(); }

    function checkRules(){
      const u = normalize(usernameInput ? usernameInput.value : '');
      const e = normalize(emailInput ? emailInput.value.split('@')[0] : '');
      const p = normalize(pw1 ? pw1.value : '');

      const similar = p && ((u && p.includes(u) && u.length >= 3) || (e && p.includes(e) && e.length >= 3));
      ruleSimilar.style.color = similar ? 'var(--pico-del-color,#c00)' : 'var(--pico-ins-color,#1a7f37)';

      const longEnough = p.length >= 8;
      ruleLength.style.color = longEnough ? 'var(--pico-ins-color,#1a7f37)' : 'var(--pico-del-color,#c00)';

      const isCommon = commonPasswords.has(p);
      ruleCommon.style.color = !isCommon && p ? 'var(--pico-ins-color,#1a7f37)' : 'var(--pico-del-color,#c00)';

      const allNumeric = /^\d+$/.test(p);
      ruleNumeric.style.color = p && !allNumeric ? 'var(--pico-ins-color,#1a7f37)' : 'var(--pico-del-color,#c00)';
    }

    ['input','change','keyup','blur'].forEach(evt => {
      if (pw1) pw1.addEventListener(evt, checkRules);
      if (usernameInput) usernameInput.addEventListener(evt, checkRules);
      if (emailInput) emailInput.addEventListener(evt, checkRules);
    });

    document.addEventListener('DOMContentLoaded', checkRules);

    // --- Realtime availability checks ---
    const usernameStatus = document.getElementById('username-status');
    const emailStatus = document.getElementById('email-status');

    function debounce(fn, ms){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); }; }

    async function checkUsername(){
      const v = (usernameInput?.value || '').trim();
      if (!v){ usernameStatus.textContent=''; return; }
      try{
        const res = await fetch(`/accounts/api/check-username?username=${encodeURIComponent(v)}`);
        const data = await res.json();
        if (data.available){
          usernameStatus.textContent = 'Username is available';
          usernameStatus.className = 'text-sm text-success';
        } else {
          usernameStatus.textContent = 'Username is already taken';
          usernameStatus.className = 'text-sm text-error';
        }
      }catch(e){/* ignore */}
    }

    async function checkEmail(){
      const v = (emailInput?.value || '').trim();
      if (!v){ emailStatus.textContent=''; return; }
      try{
        const res = await fetch(`/accounts/api/check-email?email=${encodeURIComponent(v)}`);
        const data = await res.json();
        if (data.available){
          emailStatus.textContent = 'Email is available';
          emailStatus.className = 'text-sm text-success';
        } else {
          emailStatus.textContent = 'Email is already registered';
          emailStatus.className = 'text-sm text-error';
        }
      }catch(e){/* ignore */}
    }

    const debouncedUser = debounce(checkUsername, 300);
    const debouncedEmail = debounce(checkEmail, 300);
    if (usernameInput){ ['input','blur'].forEach(evt=>usernameInput.addEventListener(evt, debouncedUser)); }
    if (emailInput){ ['input','blur'].forEach(evt=>emailInput.addEventListener(evt, debouncedEmail)); }
    document.addEventListener('DOMContentLoaded', ()=>{ checkUsername(); checkEmail(); });
  </script>
{% endblock %}
